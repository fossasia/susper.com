{"version":3,"file":"compiler_host.js","sourceRoot":"","sources":["../../../../../tools/@angular/tsc-wrapped/src/compiler_host.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {writeFileSync} from 'fs';\nimport * as tsickle from 'tsickle';\nimport * as ts from 'typescript';\n\nimport NgOptions from './options';\nimport {MetadataCollector} from './collector';\nimport {ModuleMetadata} from './schema';\n\nexport function formatDiagnostics(d: ts.Diagnostic[]): string {\n  const host: ts.FormatDiagnosticsHost = {\n    getCurrentDirectory: () => ts.sys.getCurrentDirectory(),\n    getNewLine: () => ts.sys.newLine,\n    getCanonicalFileName: (f: string) => f\n  };\n  return ts.formatDiagnostics(d, host);\n}\n\n/**\n * Implementation of CompilerHost that forwards all methods to another instance.\n * Useful for partial implementations to override only methods they care about.\n */\nexport abstract class DelegatingHost implements ts.CompilerHost {\n  constructor(protected delegate: ts.CompilerHost) {}\n  getSourceFile =\n      (fileName: string, languageVersion: ts.ScriptTarget, onError?: (message: string) => void) =>\n          this.delegate.getSourceFile(fileName, languageVersion, onError);\n\n  getCancellationToken = () => this.delegate.getCancellationToken();\n  getDefaultLibFileName = (options: ts.CompilerOptions) =>\n      this.delegate.getDefaultLibFileName(options);\n  getDefaultLibLocation = () => this.delegate.getDefaultLibLocation();\n  writeFile: ts.WriteFileCallback = this.delegate.writeFile;\n  getCurrentDirectory = () => this.delegate.getCurrentDirectory();\n  getDirectories = (path: string): string[] =>\n      (this.delegate as any).getDirectories?(this.delegate as any).getDirectories(path): [];\n  getCanonicalFileName = (fileName: string) => this.delegate.getCanonicalFileName(fileName);\n  useCaseSensitiveFileNames = () => this.delegate.useCaseSensitiveFileNames();\n  getNewLine = () => this.delegate.getNewLine();\n  fileExists = (fileName: string) => this.delegate.fileExists(fileName);\n  readFile = (fileName: string) => this.delegate.readFile(fileName);\n  trace = (s: string) => this.delegate.trace(s);\n  directoryExists = (directoryName: string) => this.delegate.directoryExists(directoryName);\n}\n\nexport class DecoratorDownlevelCompilerHost extends DelegatingHost {\n  private ANNOTATION_SUPPORT = `\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n`;\n  /** Error messages produced by tsickle, if any. */\n  public diagnostics: ts.Diagnostic[] = [];\n\n  constructor(delegate: ts.CompilerHost, private program: ts.Program) { super(delegate); }\n\n  getSourceFile =\n      (fileName: string, languageVersion: ts.ScriptTarget, onError?: (message: string) => void) => {\n        const originalContent = this.delegate.readFile(fileName);\n        let newContent = originalContent;\n        if (!/\\.d\\.ts$/.test(fileName)) {\n          try {\n            const converted = tsickle.convertDecorators(\n                this.program.getTypeChecker(), this.program.getSourceFile(fileName));\n            if (converted.diagnostics) {\n              this.diagnostics.push(...converted.diagnostics);\n            }\n            newContent = converted.output + this.ANNOTATION_SUPPORT;\n          } catch (e) {\n            console.error('Cannot convertDecorators on file', fileName);\n            throw e;\n          }\n        }\n        return ts.createSourceFile(fileName, newContent, languageVersion, true);\n      };\n}\n\nexport class TsickleCompilerHost extends DelegatingHost {\n  /** Error messages produced by tsickle, if any. */\n  public diagnostics: ts.Diagnostic[] = [];\n\n  constructor(\n      delegate: ts.CompilerHost, private oldProgram: ts.Program, private options: NgOptions) {\n    super(delegate);\n  }\n\n  getSourceFile =\n      (fileName: string, languageVersion: ts.ScriptTarget, onError?: (message: string) => void) => {\n        let sourceFile = this.oldProgram.getSourceFile(fileName);\n        let isDefinitions = /\\.d\\.ts$/.test(fileName);\n        // Don't tsickle-process any d.ts that isn't a compilation target;\n        // this means we don't process e.g. lib.d.ts.\n        if (isDefinitions) return sourceFile;\n\n        let {output, externs, diagnostics} =\n            tsickle.annotate(this.oldProgram, sourceFile, {untyped: true});\n        this.diagnostics = diagnostics;\n        return ts.createSourceFile(fileName, output, languageVersion, true);\n      };\n}\n\nconst IGNORED_FILES = /\\.ngfactory\\.js$|\\.ngstyle\\.js$/;\n\nexport class MetadataWriterHost extends DelegatingHost {\n  private metadataCollector = new MetadataCollector({quotedNames: true});\n  private metadataCollector1 = new MetadataCollector({version: 1});\n  constructor(delegate: ts.CompilerHost, private ngOptions: NgOptions) { super(delegate); }\n\n  private writeMetadata(emitFilePath: string, sourceFile: ts.SourceFile) {\n    // TODO: replace with DTS filePath when https://github.com/Microsoft/TypeScript/pull/8412 is\n    // released\n    if (/*DTS*/ /\\.js$/.test(emitFilePath)) {\n      const path = emitFilePath.replace(/*DTS*/ /\\.js$/, '.metadata.json');\n      const metadata =\n          this.metadataCollector.getMetadata(sourceFile, !!this.ngOptions.strictMetadataEmit);\n      const metadata1 = this.metadataCollector1.getMetadata(sourceFile, false);\n      const metadatas: ModuleMetadata[] = [metadata, metadata1].filter(e => !!e);\n      if (metadatas.length) {\n        const metadataText = JSON.stringify(metadatas);\n        writeFileSync(path, metadataText, {encoding: 'utf-8'});\n      }\n    }\n  }\n\n  writeFile: ts.WriteFileCallback =\n      (fileName: string, data: string, writeByteOrderMark: boolean,\n       onError?: (message: string) => void, sourceFiles?: ts.SourceFile[]) => {\n        if (/\\.d\\.ts$/.test(fileName)) {\n          // Let the original file be written first; this takes care of creating parent directories\n          this.delegate.writeFile(fileName, data, writeByteOrderMark, onError, sourceFiles);\n\n          // TODO: remove this early return after https://github.com/Microsoft/TypeScript/pull/8412\n          // is\n          // released\n          return;\n        }\n\n        if (IGNORED_FILES.test(fileName)) {\n          return;\n        }\n\n        if (!sourceFiles) {\n          throw new Error(\n              'Metadata emit requires the sourceFiles are passed to WriteFileCallback. ' +\n              'Update to TypeScript ^1.9.0-dev');\n        }\n        if (sourceFiles.length > 1) {\n          throw new Error('Bundled emit with --out is not supported');\n        }\n        this.writeMetadata(fileName, sourceFiles[0]);\n      };\n}\n"]}